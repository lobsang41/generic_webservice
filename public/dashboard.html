<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mad Kitty Services - API Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f23;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #2a2a4a;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #a0a0a0;
            font-size: 1.1em;
        }

        .config-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #2a2a4a;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .config-section h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            color: #a0a0a0;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background: #1a1a2e;
            border: 2px solid #2a2a4a;
            border-radius: 10px;
            font-size: 1em;
            color: #e0e0e0;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .input-group input::placeholder {
            color: #555;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: #1a1a2e;
            border: 1px solid #2a2a4a;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #a0a0a0;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .data-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #2a2a4a;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
            border-left-color: #764ba2;
        }

        .data-card h4 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-card .field {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid #2a2a4a;
        }

        .data-card .field-label {
            font-weight: 600;
            color: #a0a0a0;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-card .field-value {
            color: #e0e0e0;
            margin-top: 5px;
            font-size: 1em;
        }

        .data-card .field-value code {
            background: #0f0f23;
            padding: 4px 8px;
            border-radius: 4px;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .badge-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .badge-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .badge-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #2a2a4a;
            border-radius: 15px;
            margin-top: 20px;
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #2a2a4a;
            border-radius: 15px;
            margin-top: 20px;
        }

        .empty-state h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #a0a0a0;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .stat-card h5 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 0.9em;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(17, 153, 142, 0.1);
            border-left-color: #11998e;
            color: #38ef7d;
        }

        .alert-error {
            background: rgba(235, 51, 73, 0.1);
            border-left-color: #eb3349;
            color: #f45c43;
        }

        .alert-info {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: #667eea;
            color: #667eea;
        }

        .key-display {
            background: #0f0f23;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #2a2a4a;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            color: #38ef7d;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Mad Kitty Services - API Dashboard</h1>
            <p>Visualizaci√≥n interactiva de endpoints del m√≥dulo SaaS</p>
        </div>

        <div class="config-section" id="login-section">
            <h2>üîê Login</h2>
            <div class="input-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="admin@example.com">
            </div>
            <div class="input-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Tu contrase√±a">
            </div>
            <button class="btn btn-success" onclick="doLogin()">üîì Iniciar Sesi√≥n</button>
            <div id="login-result" style="margin-top: 15px;"></div>
        </div>

        <div class="config-section" id="config-section" style="display: none;">
            <h2>‚öôÔ∏è Configuraci√≥n</h2>
            <div class="input-group">
                <label for="apiUrl">URL Base del API</label>
                <input type="text" id="apiUrl" value="http://localhost:3000/api/v1" placeholder="http://localhost:3000/api/v1">
            </div>
            <div class="input-group">
                <label for="authToken">Token de Autenticaci√≥n (JWT)</label>
                <input type="text" id="authToken" placeholder="Pega aqu√≠ tu token JWT despu√©s de hacer login" readonly>
            </div>
            <div style="margin-top: 10px;">
                <strong>Usuario:</strong> <span id="current-user-email">No autenticado</span> 
                (<span id="current-user-role">-</span>)
            </div>
            <button class="btn" onclick="testConnection()">üîå Probar Conexi√≥n</button>
            <button class="btn btn-secondary" onclick="doLogout()">üö™ Cerrar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="clearData()">üóëÔ∏è Limpiar</button>
        </div>

        <div class="tabs">
            <button class="tab" onclick="switchTab('users')">üë• Usuarios</button>
            <button class="tab active" onclick="switchTab('tiers')">üìä Tiers</button>
            <button class="tab" onclick="switchTab('clients')">üè¢ Clientes</button>
            <button class="tab" onclick="switchTab('apikeys')">üîë API Keys</button>
            <button class="tab" onclick="switchTab('ipwhitelist')">üõ°Ô∏è IP Whitelist</button>
            <button class="tab" onclick="switchTab('test')">üß™ Pruebas</button>
            <button class="tab" onclick="switchTab('audit')">üìú Audit Logs</button>
        </div>

        <div id="users-content" class="tab-content">
            <div class="config-section">
                <h2>üë§ Crear Nuevo Usuario</h2>
                <div class="input-group">
                    <label for="newUserEmail">Email</label>
                    <input type="email" id="newUserEmail" placeholder="usuario@example.com">
                </div>
                <div class="input-group">
                    <label for="newUserPassword">Password</label>
                    <input type="password" id="newUserPassword" placeholder="M√≠nimo 6 caracteres">
                </div>
                <div class="input-group">
                    <label for="newUserName">Nombre</label>
                    <input type="text" id="newUserName" placeholder="Nombre del usuario">
                </div>
                <div class="input-group">
                    <label for="newUserRole">Rol</label>
                    <select id="newUserRole" style="width: 100%; padding: 12px; background: #1a1a2e; border: 2px solid #2a2a4a; border-radius: 10px; color: #e0e0e0;">
                        <option value="user">Usuario Normal</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Scopes (solo para usuarios normales)</label>
                    <button class="btn btn-small btn-secondary" onclick="toggleUserScopeSelector()">‚öôÔ∏è Seleccionar Scopes</button>
                </div>
                
                <div id="user-scope-selector" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px;">
                    <div id="user-scope-checkboxes"></div>
                </div>
                
                <div id="selected-user-scopes-display" style="margin-top: 15px;"></div>
                
                <button class="btn btn-success" onclick="createUser()">‚ûï Crear Usuario</button>
            </div>
            <div id="create-user-result"></div>
            
            <div style="margin-top: 30px;">
                <button class="btn" onclick="loadUsers()">üìã Cargar Usuarios</button>
            </div>
            <div id="users-container"></div>
        </div>

        <div id="tiers-content" class="tab-content active">
            <button class="btn" onclick="loadTiers()">üìã Cargar Tiers</button>
            <div id="tiers-container"></div>
        </div>

        <div id="clients-content" class="tab-content">
            <button class="btn" onclick="loadClients()">üìã Cargar Clientes</button>
            <div id="clients-stats" class="stats-row"></div>
            <div id="clients-container"></div>
        </div>

        <div id="apikeys-content" class="tab-content">
            <div class="config-section">
                <h2>üîë Generar Nueva API Key con Scopes</h2>
                <div class="input-group">
                    <label for="keyClientId">ID del Cliente</label>
                    <input type="text" id="keyClientId" placeholder="Ingresa el ID del cliente">
                </div>
                <div class="input-group">
                    <label for="keyName">Nombre de la Key</label>
                    <input type="text" id="keyName" value="Production Key" placeholder="Production Key">
                </div>
                <div class="input-group">
                    <label for="keyEnvironment">Entorno</label>
                    <input type="text" id="keyEnvironment" value="production" placeholder="production">
                </div>
                
                <!-- Selector de Scopes -->
                <div class="input-group">
                    <label>üéØ Permisos (Scopes)</label>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-small" onclick="loadAvailableScopes()">üìã Ver Scopes Disponibles</button>
                        <button class="btn btn-small btn-secondary" onclick="toggleScopeSelector()">‚öôÔ∏è Selector de Scopes</button>
                    </div>
                </div>

                <!-- Grupos Predefinidos -->
                <div id="scope-groups" style="display: none; margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid #2a2a4a;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üì¶ Grupos Predefinidos</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button class="btn btn-small" onclick="selectScopeGroup('READONLY')">üëÅÔ∏è Solo Lectura</button>
                        <button class="btn btn-small" onclick="selectScopeGroup('DEVELOPER')">üë®‚Äçüíª Desarrollador</button>
                        <button class="btn btn-small" onclick="selectScopeGroup('ADMIN')">üëë Administrador</button>
                        <button class="btn btn-small btn-secondary" onclick="selectScopeGroup('SUPER_ADMIN')">‚ö° Super Admin</button>
                    </div>
                    
                    <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 15px;">üéØ Scopes Individuales</h4>
                    <div id="individual-scopes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success btn-small" onclick="applyScopeSelection()">‚úì Aplicar Selecci√≥n</button>
                        <button class="btn btn-small" onclick="clearScopeSelection()">‚úó Limpiar</button>
                    </div>
                </div>

                <!-- Scopes Seleccionados -->
                <div id="selected-scopes-display" style="margin-top: 15px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; border: 1px solid #667eea; display: none;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">‚úì Scopes Seleccionados:</h4>
                    <div id="selected-scopes-list" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>

                <button class="btn btn-success" onclick="generateApiKey()" style="margin-top: 20px;">‚ûï Generar API Key</button>
            </div>
            <div id="apikeys-result"></div>
            
            <div style="margin-top: 30px;">
                <button class="btn" onclick="loadApiKeys()">üìã Ver API Keys de Cliente</button>
                <div class="input-group" style="margin-top: 15px;">
                    <label for="listKeysClientId">ID del Cliente</label>
                    <input type="text" id="listKeysClientId" placeholder="Ingresa el ID del cliente">
                </div>
            </div>
            <div id="apikeys-container"></div>
        </div>

        <div id="test-content" class="tab-content">
            <div class="config-section">
                <h2>üß™ Test de Client API Key</h2>
                <div class="input-group">
                    <label for="testClientKey">Client API Key (mk_...)</label>
                    <input type="text" id="testClientKey" placeholder="mk_...">
                </div>
                <button class="btn btn-success" onclick="testClientApiKey()">üöÄ Probar API Key</button>
            </div>
            <div id="test-container"></div>
        </div>

        <div id="audit-content" class="tab-content">
            <div class="config-section">
                <h2>üìú Audit Logs - Registro de Cambios</h2>
                
                <!-- Filtros -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="input-group">
                        <label for="auditTableFilter">Tabla</label>
                        <select id="auditTableFilter" style="width: 100%; padding: 12px; background: #1a1a2e; border: 2px solid #2a2a4a; border-radius: 10px; color: #e0e0e0;">
                            <option value="">Todas</option>
                            <option value="users">users</option>
                            <option value="clients">clients</option>
                            <option value="api_keys">api_keys</option>
                            <option value="client_api_keys">client_api_keys</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="auditActionFilter">Acci√≥n</label>
                        <select id="auditActionFilter" style="width: 100%; padding: 12px; background: #1a1a2e; border: 2px solid #2a2a4a; border-radius: 10px; color: #e0e0e0;">
                            <option value="">Todas</option>
                            <option value="INSERT">INSERT</option>
                            <option value="UPDATE">UPDATE</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="auditUserFilter">Usuario</label>
                        <input type="text" id="auditUserFilter" placeholder="email@example.com">
                    </div>
                    <div class="input-group">
                        <label for="auditRecordFilter">Record ID</label>
                        <input type="text" id="auditRecordFilter" placeholder="user-123">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn" onclick="loadAuditLogs()">üìã Cargar Logs</button>
                    <button class="btn btn-success" onclick="loadAuditStats()">üìä Ver Estad√≠sticas</button>
                    <button class="btn btn-secondary" onclick="clearAuditFilters()">üîÑ Limpiar Filtros</button>
                    <button class="btn" onclick="exportAuditLogs('json')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üì• Exportar JSON</button>
                    <button class="btn" onclick="exportAuditLogs('csv')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">üì• Exportar CSV</button>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div id="audit-stats-container" style="display: none; margin-bottom: 20px;"></div>

            <!-- Configuraci√≥n de Retenci√≥n (Solo Admin) -->
            <div id="audit-retention-config" class="config-section" style="margin-bottom: 20px;">
                <h3>‚öôÔ∏è Configuraci√≥n de Retenci√≥n y Limpieza</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="input-group">
                        <label for="retentionDaysInput">D√≠as de Retenci√≥n</label>
                        <input type="number" id="retentionDaysInput" min="30" max="730" placeholder="180">
                        <small style="color: #888;">Logs m√°s antiguos que estos d√≠as ser√°n eliminados.</small>
                    </div>
                    <div class="input-group">
                        <label for="cleanupHourInput">Hora de Limpieza (0-23)</label>
                        <input type="number" id="cleanupHourInput" min="0" max="23" placeholder="2">
                        <small style="color: #888;">Hora local en la que se ejecuta el proceso autom√°tico.</small>
                    </div>
                    <div class="input-group" style="display: flex; flex-direction: column; justify-content: center;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="cleanupEnabledInput" style="width: auto;">
                            Habilitar Limpieza Autom√°tica
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-success" onclick="updateRetentionConfigUI()">üíæ Guardar Configuraci√≥n</button>
                    <button class="btn btn-error" onclick="runManualCleanupUI()">üóëÔ∏è Limpiar Ahora (Manual)</button>
                    <div id="retention-status-msg" style="color: #a0a0a0; font-size: 0.9em;"></div>
                </div>

                <div id="cleanup-stats-panel" style="margin-top: 15px; padding: 10px; background: #0f0f1e; border-radius: 5px; display: none;">
                    <p style="margin: 0; color: #888; font-size: 0.85em;">
                        <strong>√öltima Limpieza:</strong> <span id="lastCleanupDate">-</span> | 
                        <strong>Registros Eliminados:</strong> <span id="lastCleanupCount">0</span>
                    </p>
                </div>
            </div>

            <!-- Lista de logs -->
            <div id="audit-container"></div>
        </div>

        <div id="ipwhitelist-content" class="tab-content">
            <div class="config-section">
                <h2>üõ°Ô∏è IP Whitelisting - Gesti√≥n de IPs Permitidas</h2>
                <p style="color: #a0a0a0; margin-bottom: 20px;">
                    Controla qu√© direcciones IP pueden acceder a los recursos de cada cliente. 
                    Soporta IPs individuales y rangos CIDR (ej: 192.168.1.0/24).
                </p>

                <!-- Agregar Nueva IP -->
                <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>‚ûï Agregar IP Permitida</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="input-group">
                            <label for="ipClientId">ID del Cliente</label>
                            <input type="text" id="ipClientId" placeholder="client-123">
                        </div>
                        
                        <div class="input-group">
                            <label for="ipType">Tipo</label>
                            <select id="ipType" onchange="toggleIPInputs()" style="width: 100%; padding: 12px; background: #1a1a2e; border: 2px solid #2a2a4a; border-radius: 10px; color: #e0e0e0;">
                                <option value="single">IP Individual</option>
                                <option value="cidr">Rango CIDR</option>
                            </select>
                        </div>
                    </div>

                    <div id="single-ip-input" style="margin-bottom: 15px;">
                        <div class="input-group">
                            <label for="ipAddress">Direcci√≥n IP</label>
                            <input type="text" id="ipAddress" placeholder="192.168.1.100">
                            <small style="color: #888;">Ejemplo: 192.168.1.100 o 2001:db8::1</small>
                        </div>
                    </div>

                    <div id="cidr-input" style="display: none; margin-bottom: 15px;">
                        <div class="input-group">
                            <label for="cidrRange">Rango CIDR</label>
                            <input type="text" id="cidrRange" placeholder="192.168.1.0/24">
                            <small style="color: #888;">Ejemplo: 192.168.1.0/24 (256 IPs) o 10.0.0.0/16 (65,536 IPs)</small>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="ipDescription">Descripci√≥n (opcional)</label>
                        <input type="text" id="ipDescription" placeholder="Oficina principal, VPN, etc.">
                    </div>

                    <button class="btn btn-success" onclick="addIPWhitelist()">‚úÖ Agregar IP</button>
                </div>

                <!-- Listar IPs -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <div class="input-group" style="flex: 1;">
                        <label for="listIPClientId">ID del Cliente</label>
                        <input type="text" id="listIPClientId" placeholder="client-123">
                    </div>
                    <button class="btn" onclick="loadIPWhitelist()" style="align-self: flex-end;">üìã Cargar IPs</button>
                </div>
            </div>

            <div id="ipwhitelist-result"></div>
            <div id="ipwhitelist-container"></div>
        </div>
    </div>

    <script>
        function getApiUrl() {
            return document.getElementById('apiUrl').value;
        }

        function getAuthToken() {
            return document.getElementById('authToken').value;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-content').classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'audit') {
                loadRetentionConfigUI();
            }
        }

        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="loading-container">
                    <div class="loading"></div>
                    <p style="margin-top: 20px; color: #a0a0a0;">Cargando datos...</p>
                </div>
            `;
        }

        function showEmpty(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="empty-state">
                    <h3>üì≠ Sin datos</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        async function makeRequest(endpoint, options = {}) {
            try {
                const url = getApiUrl() + endpoint;
                const token = getAuthToken();
                
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (token && !options.useClientKey) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                if (options.useClientKey) {
                    const clientKey = document.getElementById('testClientKey').value;
                    if (clientKey) {
                        headers['X-API-Key'] = clientKey;
                    }
                }
                
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Error en la petici√≥n');
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }

        async function loadTiers() {
            showLoading('tiers-container');
            
            try {
                const response = await makeRequest('/client-tiers');
                const tiers = response.data.tiers;
                
                if (!tiers || tiers.length === 0) {
                    showEmpty('tiers-container', 'No hay tiers disponibles');
                    return;
                }
                
                const container = document.getElementById('tiers-container');
                container.innerHTML = `<div class="data-grid">${tiers.map(tier => `
                    <div class="data-card">
                        <h4>üìä ${tier.name}</h4>
                        <div class="field">
                            <div class="field-label">ID</div>
                            <div class="field-value"><code>${tier.id}</code></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Descripci√≥n</div>
                            <div class="field-value">${tier.description || 'N/A'}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Llamadas/Mes</div>
                            <div class="field-value"><strong>${tier.max_api_calls_per_month.toLocaleString()}</strong></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Llamadas/Minuto</div>
                            <div class="field-value"><strong>${tier.max_api_calls_per_minute}</strong></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Usuarios M√°x</div>
                            <div class="field-value"><strong>${tier.max_users}</strong></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Precio Mensual</div>
                            <div class="field-value"><strong>$${tier.price_monthly}</strong></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Estado</div>
                            <div class="field-value">
                                <span class="badge ${tier.is_active ? 'badge-success' : 'badge-danger'}">
                                    ${tier.is_active ? 'Activo' : 'Inactivo'}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('')}</div>`;
            } catch (error) {
                showEmpty('tiers-container', 'Error al cargar tiers: ' + error.message);
            }
        }

        async function loadClients() {
            showLoading('clients-container');
            
            try {
                const response = await makeRequest('/clients');
                const clients = response.data.clients;
                const total = response.data.pagination?.total || clients.length;
                
                document.getElementById('clients-stats').innerHTML = `
                    <div class="stat-card">
                        <h5>Total Clientes</h5>
                        <div class="stat-value">${total}</div>
                    </div>
                    <div class="stat-card">
                        <h5>Activos</h5>
                        <div class="stat-value">${clients.filter(c => c.is_active).length}</div>
                    </div>
                `;
                
                if (!clients || clients.length === 0) {
                    showEmpty('clients-container', 'No hay clientes registrados');
                    return;
                }
                
                const container = document.getElementById('clients-container');
                container.innerHTML = `<div class="data-grid">${clients.map(client => `
                    <div class="data-card">
                        <h4>üè¢ ${client.name}</h4>
                        <div class="field">
                            <div class="field-label">ID</div>
                            <div class="field-value"><code>${client.id}</code></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Slug</div>
                            <div class="field-value"><code>${client.slug}</code></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Tier</div>
                            <div class="field-value"><span class="badge badge-info">${client.tier_id}</span></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Contacto</div>
                            <div class="field-value">${client.contact_name}<br><small>${client.contact_email}</small></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Uso Mensual</div>
                            <div class="field-value"><strong>${client.api_calls_current_month.toLocaleString()}</strong> llamadas</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Estado</div>
                            <div class="field-value">
                                <span class="badge ${client.is_active ? 'badge-success' : 'badge-danger'}">
                                    ${client.is_active ? 'Activo' : 'Inactivo'}
                                </span>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-small" onclick="viewClientUsage('${client.id}')">üìä Ver Uso</button>
                            <button class="btn btn-small btn-success" onclick="copyClientId('${client.id}')">üìã Copiar ID</button>
                        </div>
                    </div>
                `).join('')}</div>`;
            } catch (error) {
                showEmpty('clients-container', 'Error al cargar clientes: ' + error.message);
            }
        }

        function copyClientId(clientId) {
            navigator.clipboard.writeText(clientId);
            alert('ID copiado al portapapeles: ' + clientId);
        }

        async function viewClientUsage(clientId) {
            try {
                const response = await makeRequest(`/clients/${clientId}/usage`);
                const data = response.data;
                
                alert(`Estad√≠sticas de ${data.client.name}:\n\n` +
                    `Uso actual: ${data.usage.current_month_calls.toLocaleString()} llamadas\n` +
                    `L√≠mite: ${data.usage.limit_month_calls.toLocaleString()} llamadas\n` +
                    `Porcentaje usado: ${data.usage.percentage_used.toFixed(2)}%\n` +
                    `Restantes: ${data.usage.remaining_calls.toLocaleString()} llamadas`
                );
            } catch (error) {
                alert('Error al cargar estad√≠sticas: ' + error.message);
            }
        }

        // ============================================================================
        // GESTI√ìN DE SCOPES
        // ============================================================================
        
        let availableScopes = [];
        let scopeGroups = {};
        let selectedScopes = [];

        async function loadAvailableScopes() {
            const clientId = document.getElementById('keyClientId').value;
            
            if (!clientId) {
                alert('Por favor ingresa primero un ID de cliente');
                return;
            }

            try {
                const response = await makeRequest(`/clients/${clientId}/api-keys/scopes`);
                availableScopes = response.data.scopes;
                scopeGroups = response.data.groups;
                
                // Mostrar informaci√≥n de scopes
                const scopeInfo = availableScopes.map(s => `${s.scope}: ${s.description}`).join('\n');
                alert(`üìã Scopes Disponibles (${availableScopes.length}):\n\n${scopeInfo.substring(0, 500)}...\n\nUsa el Selector de Scopes para elegir permisos.`);
                
                // Llenar selector de scopes individuales
                fillIndividualScopes();
            } catch (error) {
                alert('Error al cargar scopes: ' + error.message);
            }
        }

        function fillIndividualScopes() {
            const container = document.getElementById('individual-scopes');
            container.innerHTML = availableScopes.map(scopeItem => `
                <label style="display: flex; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; border: 1px solid #2a2a4a;">
                    <input type="checkbox" 
                           value="${scopeItem.scope}" 
                           onchange="toggleScope('${scopeItem.scope}')"
                           style="margin-right: 8px; cursor: pointer;">
                    <span style="font-size: 0.85em; color: #e0e0e0;" title="${scopeItem.description}">
                        ${scopeItem.scope}
                    </span>
                </label>
            `).join('');
        }

        function toggleScopeSelector() {
            const selector = document.getElementById('scope-groups');
            if (selector.style.display === 'none') {
                if (availableScopes.length === 0) {
                    alert('Primero carga los scopes disponibles usando el bot√≥n "Ver Scopes Disponibles"');
                    return;
                }
                selector.style.display = 'block';
            } else {
                selector.style.display = 'none';
            }
        }

        function selectScopeGroup(groupName) {
            if (!scopeGroups[groupName]) {
                alert('Grupo no encontrado');
                return;
            }

            const groupScopes = scopeGroups[groupName].scopes;
            
            // Limpiar selecci√≥n actual
            selectedScopes = [];
            
            // Agregar todos los scopes del grupo
            selectedScopes = [...groupScopes];
            
            // Actualizar checkboxes
            document.querySelectorAll('#individual-scopes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = selectedScopes.includes(checkbox.value);
            });
            
            updateSelectedScopesDisplay();
            
            alert(`‚úì Grupo "${scopeGroups[groupName].name}" seleccionado\n\n${scopeGroups[groupName].description}\n\nScopes: ${selectedScopes.length}`);
        }

        function toggleScope(scope) {
            const index = selectedScopes.indexOf(scope);
            if (index > -1) {
                selectedScopes.splice(index, 1);
            } else {
                selectedScopes.push(scope);
            }
            updateSelectedScopesDisplay();
        }

        function updateSelectedScopesDisplay() {
            const display = document.getElementById('selected-scopes-display');
            const list = document.getElementById('selected-scopes-list');
            
            if (selectedScopes.length === 0) {
                display.style.display = 'none';
                return;
            }
            
            display.style.display = 'block';
            list.innerHTML = selectedScopes.map(scope => `
                <span class="badge badge-info" style="cursor: pointer;" onclick="removeScope('${scope}')" title="Click para remover">
                    ${scope} ‚úó
                </span>
            `).join('');
        }

        function removeScope(scope) {
            const index = selectedScopes.indexOf(scope);
            if (index > -1) {
                selectedScopes.splice(index, 1);
            }
            
            // Actualizar checkbox
            const checkbox = document.querySelector(`#individual-scopes input[value="${scope}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            updateSelectedScopesDisplay();
        }

        function applyScopeSelection() {
            if (selectedScopes.length === 0) {
                alert('No has seleccionado ning√∫n scope');
                return;
            }
            
            alert(`‚úì ${selectedScopes.length} scopes seleccionados y listos para usar en la API Key`);
            document.getElementById('scope-groups').style.display = 'none';
        }

        function clearScopeSelection() {
            selectedScopes = [];
            document.querySelectorAll('#individual-scopes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedScopesDisplay();
        }

        async function generateApiKey() {
            const clientId = document.getElementById('keyClientId').value;
            const keyName = document.getElementById('keyName').value;
            const environment = document.getElementById('keyEnvironment').value;
            
            if (!clientId) {
                alert('Por favor ingresa un ID de cliente');
                return;
            }
            
            const requestBody = {
                name: keyName,
                environment: environment
            };
            
            // Agregar scopes si hay seleccionados
            if (selectedScopes.length > 0) {
                requestBody.scopes = selectedScopes;
            }
            
            try {
                const response = await makeRequest(`/clients/${clientId}/api-keys`, {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });
                
                const scopesInfo = response.data.apiKey.scopes && response.data.apiKey.scopes.length > 0
                    ? `<div class="field" style="margin-top: 15px;">
                         <div class="field-label">Scopes Asignados (${response.data.apiKey.scopes.length})</div>
                         <div class="field-value" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px;">
                           ${response.data.apiKey.scopes.map(s => `<span class="badge badge-info">${s}</span>`).join('')}
                         </div>
                       </div>`
                    : '<div class="alert alert-info" style="margin-top: 10px;"><strong>‚ö†Ô∏è Sin scopes:</strong> Esta key tiene acceso limitado</div>';
                
                const container = document.getElementById('apikeys-result');
                container.innerHTML = `
                    <div class="alert alert-success" style="margin-top: 20px;">
                        <h4>‚úÖ API Key Generada Exitosamente</h4>
                        <p style="margin-top: 10px; margin-bottom: 10px;">‚ö†Ô∏è <strong>Guarda esta key ahora. No podr√°s verla de nuevo.</strong></p>
                        <div class="key-display">${response.data.key}</div>
                        ${scopesInfo}
                        <button class="btn btn-success" style="margin-top: 15px;" onclick="copyToClipboard('${response.data.key}')">üìã Copiar Key</button>
                    </div>
                `;
                
                // Limpiar selecci√≥n de scopes
                clearScopeSelection();
            } catch (error) {
                const container = document.getElementById('apikeys-result');
                container.innerHTML = `
                    <div class="alert alert-error" style="margin-top: 20px;">
                        <h4>‚ùå Error al Generar API Key</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert('API Key copiada al portapapeles!');
        }

        async function loadApiKeys() {
            const clientId = document.getElementById('listKeysClientId').value;
            
            if (!clientId) {
                alert('Por favor ingresa un ID de cliente');
                return;
            }
            
            showLoading('apikeys-container');
            
            try {
                const response = await makeRequest(`/clients/${clientId}/api-keys`);
                const keys = response.data.apiKeys;
                
                if (!keys || keys.length === 0) {
                    showEmpty('apikeys-container', 'Este cliente no tiene API Keys');
                    return;
                }
                
                const container = document.getElementById('apikeys-container');
                container.innerHTML = `<div class="data-grid">${keys.map(key => {
                    const scopesDisplay = key.scopes && key.scopes.length > 0
                        ? `<div class="field">
                             <div class="field-label">Scopes (${key.scopes.length})</div>
                             <div class="field-value" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                               ${key.scopes.map(s => `<span class="badge badge-info" style="font-size: 0.75em;">${s}</span>`).join('')}
                             </div>
                           </div>`
                        : `<div class="field">
                             <div class="field-label">Scopes</div>
                             <div class="field-value"><span class="badge badge-warning">Sin scopes definidos</span></div>
                           </div>`;
                    
                    return `
                    <div class="data-card">
                        <h4>üîë ${key.name}</h4>
                        <div class="field">
                            <div class="field-label">ID</div>
                            <div class="field-value"><code>${key.id}</code></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Entorno</div>
                            <div class="field-value"><span class="badge badge-info">${key.environment}</span></div>
                        </div>
                        ${scopesDisplay}
                        <div class="field">
                            <div class="field-label">√öltimo Uso</div>
                            <div class="field-value">${key.last_used_at ? new Date(key.last_used_at).toLocaleString() : 'Nunca'}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Expira</div>
                            <div class="field-value">${key.expires_at ? new Date(key.expires_at).toLocaleString() : 'Nunca'}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Estado</div>
                            <div class="field-value">
                                <span class="badge ${key.is_active ? 'badge-success' : 'badge-danger'}">
                                    ${key.is_active ? 'Activa' : 'Revocada'}
                                </span>
                            </div>
                        </div>
                    </div>
                `}).join('')}</div>`;
            } catch (error) {
                showEmpty('apikeys-container', 'Error al cargar API Keys: ' + error.message);
            }
        }

        async function testClientApiKey() {
            const clientKey = document.getElementById('testClientKey').value;
            
            if (!clientKey) {
                alert('Por favor ingresa una Client API Key');
                return;
            }
            
            showLoading('test-container');
            
            try {
                const response = await makeRequest('/client-test/test', { useClientKey: true });
                
                document.getElementById('test-container').innerHTML = `
                    <div class="alert alert-success" style="margin-top: 20px;">
                        <h4>‚úÖ Client API Key V√°lida</h4>
                    </div>
                    <div class="data-grid" style="margin-top: 20px;">
                        <div class="data-card">
                            <h4>üè¢ Cliente</h4>
                            <div class="field">
                                <div class="field-label">Nombre</div>
                                <div class="field-value">${response.data.client.name}</div>
                            </div>
                            <div class="field">
                                <div class="field-label">Tier</div>
                                <div class="field-value"><span class="badge badge-info">${response.data.client.tier}</span></div>
                            </div>
                        </div>
                        <div class="data-card">
                            <h4>üìä L√≠mites</h4>
                            <div class="field">
                                <div class="field-label">Llamadas/Mes</div>
                                <div class="field-value"><strong>${response.data.tier.max_api_calls_per_month.toLocaleString()}</strong></div>
                            </div>
                            <div class="field">
                                <div class="field-label">Llamadas/Minuto</div>
                                <div class="field-value"><strong>${response.data.tier.max_api_calls_per_minute}</strong></div>
                            </div>
                        </div>
                        <div class="data-card">
                            <h4>üìà Uso Actual</h4>
                            <div class="field">
                                <div class="field-label">Uso Mensual</div>
                                <div class="field-value"><strong>${response.data.usage.current_month.toLocaleString()}</strong> / ${response.data.usage.limit_month.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('test-container').innerHTML = `
                    <div class="alert alert-error" style="margin-top: 20px;">
                        <h4>‚ùå Error al Probar API Key</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ============================================================================
        // AUDIT LOGS
        // ============================================================================

        async function loadAuditLogs(page = 1) {
            showLoading('audit-container');
            
            try {
                // Construir query params
                const params = new URLSearchParams();
                params.append('page', page);
                params.append('limit', '20');
                
                const tableFilter = document.getElementById('auditTableFilter').value;
                if (tableFilter) params.append('table_name', tableFilter);
                
                const actionFilter = document.getElementById('auditActionFilter').value;
                if (actionFilter) params.append('action', actionFilter);
                
                const userFilter = document.getElementById('auditUserFilter').value;
                if (userFilter) params.append('changed_by', userFilter);
                
                const recordFilter = document.getElementById('auditRecordFilter').value;
                if (recordFilter) params.append('record_id', recordFilter);
                
                const response = await makeRequest(`/audit-logs?${params.toString()}`);
                
                if (!response.data.logs || response.data.logs.length === 0) {
                    showEmpty('audit-container', 'No se encontraron registros de auditor√≠a');
                    return;
                }
                
                const logs = response.data.logs;
                const pagination = response.data.pagination;
                
                let html = '<div class="data-grid">';
                
                logs.forEach(log => {
                    const actionBadge = getActionBadge(log.action);
                    const tableBadge = getTableBadge(log.table_name);
                    const date = new Date(log.changed_at).toLocaleString('es-ES');
                    
                    html += `
                        <div class="data-card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    ${tableBadge}
                                    ${actionBadge}
                                </div>
                                <span style="color: #888; font-size: 0.85em;">${date}</span>
                            </div>
                            
                            <div class="field">
                                <div class="field-label">Record ID</div>
                                <div class="field-value"><code>${log.record_id}</code></div>
                            </div>
                            
                            ${log.changed_by ? `
                                <div class="field">
                                    <div class="field-label">üë§ Usuario</div>
                                    <div class="field-value">${log.changed_by}</div>
                                </div>
                            ` : ''}
                            
                            ${log.ip_address ? `
                                <div class="field">
                                    <div class="field-label">üåê IP</div>
                                    <div class="field-value"><code>${log.ip_address}</code></div>
                                </div>
                            ` : ''}
                            
                            ${log.old_values ? `
                                <div class="field">
                                    <div class="field-label">üìù Valores Anteriores</div>
                                    <div class="field-value"><pre style="background: #0f0f1e; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 0.85em;">${JSON.stringify(log.old_values, null, 2)}</pre></div>
                                </div>
                            ` : ''}
                            
                            ${log.new_values ? `
                                <div class="field">
                                    <div class="field-label">‚ú® Valores Nuevos</div>
                                    <div class="field-value"><pre style="background: #0f0f1e; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 0.85em;">${JSON.stringify(log.new_values, null, 2)}</pre></div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Paginaci√≥n
                if (pagination.totalPages > 1) {
                    html += '<div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">';
                    
                    if (pagination.page > 1) {
                        html += `<button class="btn btn-secondary" onclick="loadAuditLogs(${pagination.page - 1})">‚Üê Anterior</button>`;
                    }
                    
                    html += `<span style="color: #a0a0a0; padding: 10px;">P√°gina ${pagination.page} de ${pagination.totalPages}</span>`;
                    
                    if (pagination.page < pagination.totalPages) {
                        html += `<button class="btn btn-secondary" onclick="loadAuditLogs(${pagination.page + 1})">Siguiente ‚Üí</button>`;
                    }
                    
                    html += '</div>';
                }
                
                document.getElementById('audit-container').innerHTML = html;
                
            } catch (error) {
                document.getElementById('audit-container').innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Error al Cargar Audit Logs</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadAuditStats() {
            const statsContainer = document.getElementById('audit-stats-container');
            statsContainer.style.display = 'block';
            statsContainer.innerHTML = '<div class="loading"></div>';
            
            try {
                const response = await makeRequest('/audit-logs/stats/summary?days=30');
                const stats = response.data;
                
                let html = `
                    <div class="config-section">
                        <h3>üìä Estad√≠sticas de Auditor√≠a (√öltimos 30 d√≠as)</h3>
                        
                        <div class="data-grid">
                            <div class="data-card">
                                <h4>üìà Total de Cambios</h4>
                                <div style="font-size: 2em; color: #667eea; font-weight: bold; text-align: center; margin: 20px 0;">
                                    ${stats.total_changes.toLocaleString()}
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <h4>üìã Por Tabla y Acci√≥n</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                `;
                
                stats.by_table_and_action.forEach(item => {
                    const actionBadge = getActionBadge(item.action);
                    const tableBadge = getTableBadge(item.table_name);
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #2a2a4a;">
                            <div>
                                ${tableBadge}
                                ${actionBadge}
                            </div>
                            <span style="color: #667eea; font-weight: bold;">${item.count}</span>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <h4>üë• Usuarios M√°s Activos</h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                `;
                
                if (stats.top_users.length > 0) {
                    stats.top_users.forEach((user, index) => {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #2a2a4a;">
                                <div>
                                    <span style="color: #888;">#${index + 1}</span>
                                    <span style="margin-left: 10px;">${user.changed_by}</span>
                                </div>
                                <span style="color: #667eea; font-weight: bold;">${user.changes} cambios</span>
                            </div>
                        `;
                    });
                } else {
                    html += '<p style="color: #888; text-align: center;">No hay datos de usuarios</p>';
                }
                
                html += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                statsContainer.innerHTML = html;
                
            } catch (error) {
                statsContainer.innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Error al Cargar Estad√≠sticas</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function clearAuditFilters() {
            document.getElementById('auditTableFilter').value = '';
            document.getElementById('auditActionFilter').value = '';
            document.getElementById('auditUserFilter').value = '';
            document.getElementById('auditRecordFilter').value = '';
            document.getElementById('audit-stats-container').style.display = 'none';
            document.getElementById('audit-container').innerHTML = '';
        }

        function getActionBadge(action) {
            const badges = {
                'INSERT': '<span class="badge badge-success">‚ûï INSERT</span>',
                'UPDATE': '<span class="badge badge-warning">‚úèÔ∏è UPDATE</span>',
                'DELETE': '<span class="badge badge-error">üóëÔ∏è DELETE</span>'
            };
            return badges[action] || `<span class="badge">${action}</span>`;
        }

        function getTableBadge(tableName) {
            const badges = {
                'users': '<span class="badge badge-info">üë• users</span>',
                'clients': '<span class="badge badge-info">üè¢ clients</span>',
                'api_keys': '<span class="badge badge-info">üîë api_keys</span>',
                'client_api_keys': '<span class="badge badge-info">üîê client_api_keys</span>'
            };
            return badges[tableName] || `<span class="badge">${tableName}</span>`;
        }

        async function exportAuditLogs(format) {
            try {
                // Construir query params con los filtros actuales
                const params = new URLSearchParams();
                params.append('limit', '1000'); // Exportar hasta 1000 registros
                
                const tableFilter = document.getElementById('auditTableFilter').value;
                if (tableFilter) params.append('table_name', tableFilter);
                
                const actionFilter = document.getElementById('auditActionFilter').value;
                if (actionFilter) params.append('action', actionFilter);
                
                const userFilter = document.getElementById('auditUserFilter').value;
                if (userFilter) params.append('changed_by', userFilter);
                
                const recordFilter = document.getElementById('auditRecordFilter').value;
                if (recordFilter) params.append('record_id', recordFilter);
                
                // Obtener los datos
                const response = await makeRequest(`/audit-logs?${params.toString()}`);
                
                if (!response.data.logs || response.data.logs.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }
                
                const logs = response.data.logs;
                
                if (format === 'json') {
                    exportAsJSON(logs);
                } else if (format === 'csv') {
                    exportAsCSV(logs);
                }
                
            } catch (error) {
                alert(`Error al exportar: ${error.message}`);
            }
        }

        function exportAsJSON(logs) {
            const dataStr = JSON.stringify(logs, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `audit_logs_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Exportados ${logs.length} registros en formato JSON`);
        }

        function exportAsCSV(logs) {
            // Definir las columnas del CSV
            const headers = [
                'ID',
                'Tabla',
                'Record ID',
                'Acci√≥n',
                'Usuario',
                'IP',
                'User Agent',
                'Fecha',
                'Valores Anteriores',
                'Valores Nuevos'
            ];
            
            // Convertir logs a filas CSV
            const rows = logs.map(log => {
                return [
                    log.id,
                    log.table_name,
                    log.record_id,
                    log.action,
                    log.changed_by || '',
                    log.ip_address || '',
                    log.user_agent || '',
                    new Date(log.changed_at).toLocaleString('es-ES'),
                    log.old_values ? JSON.stringify(log.old_values) : '',
                    log.new_values ? JSON.stringify(log.new_values) : ''
                ].map(field => {
                    // Escapar comillas y envolver en comillas si contiene comas o saltos de l√≠nea
                    const fieldStr = String(field);
                    if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n')) {
                        return `"${fieldStr.replace(/"/g, '""')}"`;
                    }
                    return fieldStr;
                });
            });
            
            // Construir CSV
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
            
            // Descargar
            const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `audit_logs_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Exportados ${logs.length} registros en formato CSV`);
        }

        async function loadRetentionConfigUI() {
            try {
                const response = await makeRequest('/audit-logs/retention/config');
                const config = response.data;
                
                document.getElementById('retentionDaysInput').value = config.retentionDays;
                document.getElementById('cleanupHourInput').value = config.cleanupHour;
                document.getElementById('cleanupEnabledInput').checked = config.cleanupEnabled;
                
                if (config.lastCleanup) {
                    document.getElementById('cleanup-stats-panel').style.display = 'block';
                    document.getElementById('lastCleanupDate').innerText = new Date(config.lastCleanup).toLocaleString('es-ES');
                    document.getElementById('lastCleanupCount').innerText = config.lastCleanupDeleted || 0;
                }
            } catch (error) {
                console.error('Error loading retention config:', error);
                // Si falla por permisos, ocultamos la secci√≥n (probablemente no es admin)
                if (error.message.includes('403') || error.message.includes('Forbidden')) {
                    document.getElementById('audit-retention-config').style.display = 'none';
                }
            }
        }

        async function updateRetentionConfigUI() {
            const retentionDays = parseInt(document.getElementById('retentionDaysInput').value);
            const cleanupHour = parseInt(document.getElementById('cleanupHourInput').value);
            const cleanupEnabled = document.getElementById('cleanupEnabledInput').checked;
            
            const msgEl = document.getElementById('retention-status-msg');
            msgEl.innerText = '‚è≥ Guardando...';
            msgEl.style.color = '#667eea';
            
            try {
                await makeRequest('/audit-logs/retention/config', {
                    method: 'POST',
                    body: JSON.stringify({
                        retentionDays,
                        cleanupHour,
                        cleanupEnabled
                    })
                });
                
                msgEl.innerText = '‚úÖ Configuraci√≥n guardada';
                msgEl.style.color = '#48bb78';
                setTimeout(() => { msgEl.innerText = ''; }, 3000);
                
                // Recargar para confirmar
                loadRetentionConfigUI();
            } catch (error) {
                msgEl.innerText = `‚ùå Error: ${error.message}`;
                msgEl.style.color = '#f56565';
            }
        }

        async function runManualCleanupUI() {
            if (!confirm('¬øEst√°s seguro de que quieres ejecutar la limpieza manual ahora? Esto eliminar√° todos los logs m√°s antiguos que los d√≠as configurados.')) {
                return;
            }
            
            const msgEl = document.getElementById('retention-status-msg');
            msgEl.innerText = '‚è≥ Ejecutando limpieza...';
            msgEl.style.color = '#667eea';
            
            try {
                const response = await makeRequest('/audit-logs/retention/cleanup', {
                    method: 'POST'
                });
                
                alert(`‚úÖ Limpieza completada con √©xito.\nRegistros eliminados: ${response.data.deletedRecords}\nFecha de corte: ${new Date(response.data.cutoffDate).toLocaleDateString()}`);
                
                msgEl.innerText = '';
                
                // Recargar estad√≠sticas
                loadRetentionConfigUI();
                // Recargar logs actuales por si se borraron algunos visibles
                loadAuditLogs();
            } catch (error) {
                msgEl.innerText = `‚ùå Error: ${error.message}`;
                msgEl.style.color = '#f56565';
                alert(`Error en limpieza manual: ${error.message}`);
            }
        }

        // ============================================================================
        // AUTENTICACI√ìN Y GESTI√ìN DE USUARIOS
        // ============================================================================
        
        let currentUser = null;
        let userScopes = [];

        async function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Por favor ingresa email y contrase√±a');
                return;
            }

            try {
                const response = await fetch(getApiUrl() + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || 'Error en login');
                }

                // Guardar token y usuario
                document.getElementById('authToken').value = data.data.accessToken;
                currentUser = data.data.user;

                // Actualizar UI
                document.getElementById('current-user-email').textContent = currentUser.email;
                document.getElementById('current-user-role').textContent = currentUser.role;

                // Mostrar secci√≥n de configuraci√≥n y ocultar login
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('config-section').style.display = 'block';

                document.getElementById('login-result').innerHTML = `
                    <div class="alert alert-success">
                        <h4>‚úÖ Login Exitoso</h4>
                        <p>Bienvenido ${currentUser.name} (${currentUser.role})</p>
                    </div>
                `;

                // Limpiar campos
                document.getElementById('loginPassword').value = '';

                alert(`‚úÖ Login exitoso!\n\nUsuario: ${currentUser.email}\nRol: ${currentUser.role}`);
            } catch (error) {
                document.getElementById('login-result').innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Error en Login</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function doLogout() {
            document.getElementById('authToken').value = '';
            currentUser = null;
            
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('config-section').style.display = 'none';
            document.getElementById('login-result').innerHTML = '';
            
            alert('Sesi√≥n cerrada');
        }

        function toggleUserScopeSelector() {
            const selector = document.getElementById('user-scope-selector');
            if (selector.style.display === 'none') {
                if (availableScopes.length === 0) {
                    // Cargar scopes b√°sicos
                    fillUserScopeCheckboxes();
                }
                selector.style.display = 'block';
            } else {
                selector.style.display = 'none';
            }
        }

        function fillUserScopeCheckboxes() {
            const container = document.getElementById('user-scope-checkboxes');
            const basicScopes = [
                'clients:read', 'clients:write', 'clients:delete', 'clients:admin',
                'tiers:read', 'tiers:write', 'tiers:delete', 'tiers:admin',
                'api_keys:read', 'api_keys:write', 'api_keys:delete', 'api_keys:admin',
                'users:read', 'users:write', 'users:delete', 'users:admin',
                'usage:read', 'usage:write', 'usage:admin',
                'webhooks:read', 'webhooks:write', 'webhooks:delete', 'webhooks:admin',
                'analytics:read', 'analytics:write', 'analytics:admin'
            ];

            container.innerHTML = basicScopes.map(scope => `
                <label style="display: flex; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; border: 1px solid #2a2a4a; margin-bottom: 5px;">
                    <input type="checkbox" 
                           value="${scope}" 
                           onchange="toggleUserScope('${scope}')"
                           style="margin-right: 8px; cursor: pointer;">
                    <span style="font-size: 0.85em; color: #e0e0e0;">
                        ${scope}
                    </span>
                </label>
            `).join('');
        }

        function toggleUserScope(scope) {
            const index = userScopes.indexOf(scope);
            if (index > -1) {
                userScopes.splice(index, 1);
            } else {
                userScopes.push(scope);
            }
            updateUserScopesDisplay();
        }

        function updateUserScopesDisplay() {
            const display = document.getElementById('selected-user-scopes-display');
            
            if (userScopes.length === 0) {
                display.innerHTML = '';
                return;
            }
            
            display.innerHTML = `
                <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; border: 1px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">‚úì Scopes Seleccionados (${userScopes.length}):</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${userScopes.map(scope => `
                            <span class="badge badge-info" style="cursor: pointer;" onclick="toggleUserScope('${scope}')" title="Click para remover">
                                ${scope} ‚úó
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function createUser() {
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const name = document.getElementById('newUserName').value;
            const role = document.getElementById('newUserRole').value;

            if (!email || !password) {
                alert('Email y contrase√±a son requeridos');
                return;
            }

            const requestBody = {
                email,
                password,
                name: name || email.split('@')[0],
                role
            };

            // Solo agregar scopes si es usuario normal y hay scopes seleccionados
            if (role === 'user' && userScopes.length > 0) {
                requestBody.scopes = userScopes;
            }

            try {
                const response = await makeRequest('/users', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });

                const scopesInfo = response.data.user.permissions
                    ? `<div class="field" style="margin-top: 10px;">
                         <div class="field-label">Scopes Asignados</div>
                         <div class="field-value">${response.data.user.permissions.scopes.join(', ')}</div>
                       </div>`
                    : '';

                document.getElementById('create-user-result').innerHTML = `
                    <div class="alert alert-success" style="margin-top: 20px;">
                        <h4>‚úÖ Usuario Creado Exitosamente</h4>
                        <div class="field">
                            <div class="field-label">Email</div>
                            <div class="field-value">${response.data.user.email}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">Rol</div>
                            <div class="field-value"><span class="badge badge-info">${response.data.user.role}</span></div>
                        </div>
                        ${scopesInfo}
                    </div>
                `;

                // Limpiar formulario
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('newUserName').value = '';
                userScopes = [];
                updateUserScopesDisplay();
                document.querySelectorAll('#user-scope-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
            } catch (error) {
                document.getElementById('create-user-result').innerHTML = `
                    <div class="alert alert-error" style="margin-top: 20px;">
                        <h4>‚ùå Error al Crear Usuario</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadUsers() {
            showLoading('users-container');

            try {
                const response = await makeRequest('/users');
                const users = response.data.users;

                if (!users || users.length === 0) {
                    showEmpty('users-container', 'No hay usuarios registrados');
                    return;
                }

                const container = document.getElementById('users-container');
                container.innerHTML = `<div class="data-grid">${users.map(user => {
                    const scopesDisplay = user.permissions
                        ? `<div class="field">
                             <div class="field-label">Scopes</div>
                             <div class="field-value" style="display: flex; flex-wrap: wrap; gap: 5px;">
                               ${user.permissions.scopes.map(s => `<span class="badge badge-info" style="font-size: 0.75em;">${s}</span>`).join('')}
                             </div>
                           </div>`
                        : '';

                    return `
                    <div class="data-card">
                        <h4>üë§ ${user.name}</h4>
                        <div class="field">
                            <div class="field-label">Email</div>
                            <div class="field-value">${user.email}</div>
                        </div>
                        <div class="field">
                            <div class="field-label">ID</div>
                            <div class="field-value"><code>${user.id}</code></div>
                        </div>
                        <div class="field">
                            <div class="field-label">Rol</div>
                            <div class="field-value"><span class="badge ${user.role === 'admin' ? 'badge-danger' : 'badge-info'}">${user.role}</span></div>
                        </div>
                        ${scopesDisplay}
                        <div class="field">
                            <div class="field-label">Creado</div>
                            <div class="field-value">${new Date(user.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                `}).join('')}</div>`;
            } catch (error) {
                showEmpty('users-container', 'Error al cargar usuarios: ' + error.message);
            }
        }

        async function testConnection() {
            try {
                const response = await makeRequest('/client-tiers');
                alert(`‚úÖ Conexi√≥n exitosa!\n\nTiers disponibles: ${response.data.tiers.length}`);
            } catch (error) {
                alert(`‚ùå Error de conexi√≥n:\n\n${error.message}`);
            }
        }

        function clearData() {
            document.getElementById('tiers-container').innerHTML = '';
            document.getElementById('clients-container').innerHTML = '';
            document.getElementById('clients-stats').innerHTML = '';
            document.getElementById('apikeys-container').innerHTML = '';
            document.getElementById('apikeys-result').innerHTML = '';
            document.getElementById('test-container').innerHTML = '';
        }

        // Auto-load tiers on page load
        window.addEventListener('load', () => {
            loadTiers();
        });

        // ============================================================================
        // IP WHITELISTING FUNCTIONS
        // ============================================================================

        function toggleIPInputs() {
            const ipType = document.getElementById('ipType').value;
            const singleInput = document.getElementById('single-ip-input');
            const cidrInput = document.getElementById('cidr-input');

            if (ipType === 'single') {
                singleInput.style.display = 'block';
                cidrInput.style.display = 'none';
            } else {
                singleInput.style.display = 'none';
                cidrInput.style.display = 'block';
            }
        }

        async function addIPWhitelist() {
            const clientId = document.getElementById('ipClientId').value;
            const ipType = document.getElementById('ipType').value;
            const ipAddress = document.getElementById('ipAddress').value;
            const cidrRange = document.getElementById('cidrRange').value;
            const description = document.getElementById('ipDescription').value;

            if (!clientId) {
                alert('Por favor ingresa el ID del cliente');
                return;
            }

            const requestBody = {
                description: description || undefined
            };

            if (ipType === 'single') {
                if (!ipAddress) {
                    alert('Por favor ingresa una direcci√≥n IP');
                    return;
                }
                requestBody.ip_address = ipAddress;
            } else {
                if (!cidrRange) {
                    alert('Por favor ingresa un rango CIDR');
                    return;
                }
                requestBody.cidr_range = cidrRange;
            }

            try {
                const response = await makeRequest(`/clients/${clientId}/ip-whitelist`, {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });

                const entry = response.data.entry;
                const ipDisplay = entry.ip_address || entry.cidr_range;

                document.getElementById('ipwhitelist-result').innerHTML = `
                    <div class="alert alert-success" style="margin-top: 20px;">
                        <h4>‚úÖ IP Agregada Exitosamente</h4>
                        <div class="field">
                            <div class="field-label">IP/CIDR</div>
                            <div class="field-value"><code>${ipDisplay}</code></div>
                        </div>
                        ${entry.description ? `
                            <div class="field">
                                <div class="field-label">Descripci√≥n</div>
                                <div class="field-value">${entry.description}</div>
                            </div>
                        ` : ''}
                        <div class="field">
                            <div class="field-label">ID</div>
                            <div class="field-value"><code>${entry.id}</code></div>
                        </div>
                    </div>
                `;

                // Limpiar formulario
                document.getElementById('ipAddress').value = '';
                document.getElementById('cidrRange').value = '';
                document.getElementById('ipDescription').value = '';

                // Recargar lista si est√° el mismo cliente
                const listClientId = document.getElementById('listIPClientId').value;
                if (listClientId === clientId) {
                    loadIPWhitelist();
                }
            } catch (error) {
                document.getElementById('ipwhitelist-result').innerHTML = `
                    <div class="alert alert-error" style="margin-top: 20px;">
                        <h4>‚ùå Error al Agregar IP</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadIPWhitelist() {
            const clientId = document.getElementById('listIPClientId').value;

            if (!clientId) {
                alert('Por favor ingresa el ID del cliente');
                return;
            }

            showLoading('ipwhitelist-container');

            try {
                const response = await makeRequest(`/clients/${clientId}/ip-whitelist`);
                const entries = response.data.entries;

                if (!entries || entries.length === 0) {
                    showEmpty('ipwhitelist-container', 'Este cliente no tiene IPs en whitelist');
                    return;
                }

                const container = document.getElementById('ipwhitelist-container');
                container.innerHTML = `
                    <div class="config-section">
                        <h3>üìã IPs Permitidas (${entries.length})</h3>
                        <div class="data-grid">
                            ${entries.map(entry => {
                                const ipDisplay = entry.ip_address || entry.cidr_range;
                                const ipType = entry.ip_address ? 'IP Individual' : 'Rango CIDR';
                                const date = new Date(entry.created_at).toLocaleString('es-ES');

                                return `
                                    <div class="data-card">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                            <div>
                                                <span class="badge badge-success">${ipType}</span>
                                                ${entry.is_active ? 
                                                    '<span class="badge badge-info">Activa</span>' : 
                                                    '<span class="badge" style="background: #666;">Inactiva</span>'
                                                }
                                            </div>
                                            <button class="btn btn-error btn-small" onclick="removeIPWhitelist('${clientId}', '${entry.id}')">
                                                üóëÔ∏è Eliminar
                                            </button>
                                        </div>

                                        <div class="field">
                                            <div class="field-label">üåê ${ipType}</div>
                                            <div class="field-value"><code style="font-size: 1.1em;">${ipDisplay}</code></div>
                                        </div>

                                        ${entry.description ? `
                                            <div class="field">
                                                <div class="field-label">üìù Descripci√≥n</div>
                                                <div class="field-value">${entry.description}</div>
                                            </div>
                                        ` : ''}

                                        <div class="field">
                                            <div class="field-label">üÜî ID</div>
                                            <div class="field-value"><code>${entry.id}</code></div>
                                        </div>

                                        ${entry.created_by ? `
                                            <div class="field">
                                                <div class="field-label">üë§ Creado por</div>
                                                <div class="field-value">${entry.created_by}</div>
                                            </div>
                                        ` : ''}

                                        <div class="field">
                                            <div class="field-label">üìÖ Fecha de Creaci√≥n</div>
                                            <div class="field-value">${date}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('ipwhitelist-container').innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå Error al Cargar IPs</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function removeIPWhitelist(clientId, entryId) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta IP de la whitelist?')) {
                return;
            }

            try {
                await makeRequest(`/clients/${clientId}/ip-whitelist/${entryId}`, {
                    method: 'DELETE'
                });

                alert('‚úÖ IP eliminada exitosamente');
                loadIPWhitelist();
            } catch (error) {
                alert(`‚ùå Error al eliminar IP: ${error.message}`);
            }
        }
    </script>
</body>
</html>
